--- 
wordpress_id: 462
layout: post
title: !binary |
  5re66KuHIEJCUyDos4fmlpnnmoTlronlhajmgKc=

date: 2007-09-26 23:52:52 +08:00
wordpress_url: http://blog.xdite.net/?p=462
---
寫在前面，如果你看到這一篇文章，我代為宣傳一下：

<font color="#ff0000"><big><big><big>請儘速修改你的 PTT 密碼！</big></big></big></font>

（如果沒有玩 BBS，就把這篇文章當作是篇比較八卦的知識文章吧。）

---------------------------------

相信大家前幾天都有看到這則新聞：「<a href="http://www.ettoday.com/2007/09/22/123-2161477.htm">破解中華電、批踢踢～駭客竊千萬個資　林志玲也受害！</a>」。苦主有中華電信、台灣深藍學生論壇、卡提諾論壇、EzPeer、無名小站、雅虎、Google、PChome、艾噹洛學院等十個大型網站。鄉民最愛的批踢踢實業坊（ptt）也慘遭毒手。

最近，PTT 進站畫面底下悄悄上了一行黃字：<font color="#ff0000">[公告] 請更換您的密碼以保護帳號安全</font>，不過好像沒多少人在意，大部分以為密碼有加密就沒事了。筆者想乾脆趁這個機會稍稍淺談一下 BBS 資料的資訊保全，讓大家知道<b>換掉密碼</b>以及<b>避免在 BBS 留下敏感資訊</b>的重要性，所以寫了這篇文章。（因為鑑於 BBS 架設有一定的門檻，管理上也需要一定的知識，知道 BBS 運作原理的算少數）


[注意，本篇所稱情形不全指 PTT，是通指一般 BBS 的情形，如有任何謬誤之處，請各位先進不吝指正]


<b><big><big>常見誤解</big></big></b>

因為缺乏深入的知識，以及 WEB 的普遍化，一般使用者對 BBS 與盜資料常有幾個誤解：

1. 盜資料就是「偷盜」 == 偷走就不見了。（錯的）

所以管理者常會用<b>資料沒有不見</b>作為安撫使用者災情不嚴重的藉口，事實上這是錯的。真正的 盜資料 ==「<b>偷偷拷貝一份</b>」。如果沒有 LOG，你偷打開同學的拷同學的 A 片會被抓到嗎？答案是不會。除非你忘記關機或是不小心把拷貝A片到隨身硬碟做錯變成剪下A片，同學發現 A 片不見了才會被逮。入侵電腦偷盜行為也是一樣，除非在偷盜資料過程留下線索（丟進來的後門與留下的 LOG 忘記清，結果被巡察到），否則很少人知道管的服務曾經被入侵過。（這次事件報案的深藍論壇，也是站長例行巡察 LOG 後發現有人入侵，所以才能報案逮人）。


所以<a href="http://blog.xdite.net/?p=209">去年無名小站的與駭客拉鋸激戰十幾分鐘</a>，和被盜十三筆資料那是唬人的，會相信這番說詞的是丁丁。


2. BBS 系統裡面四處都有 LOG。（這句話也是錯的）

如果 BBS 沒有自行重寫過的話，通常是只有 <b>登入 / 打錯密碼的 LOG</b>，還有 <b>新增資料的 LOG （ POST 文章、丟水球、寫信、修改使用者資料、修改文章）</b>。至於 <b>讀取 以及 刪除的 LOG 是付之闕如</b>。（就像 PTT 上次發生 <a href="http://blog.xdite.net/?p=445">人人變站長 事件</a>，當時誰資料又被誰誰偷看，無從考證起；如果文章被大 D 刪除，也是再也撈不回來）。

<b><big><big>你所不知道的事</big></big></b>

另外，其實也有幾個大眾不太知道的事實。筆者在上一段講的 LOG 僅僅是指 BBS 上的 LOG，而 BBS 系統只是跑在這個 Unix 上的一支程式。再者，BBS 裡的檔案絕大多數是明文文字檔，因此<b>站長直接從 Unix 上做的任何讀取、變更、刪除的動作都絕對不會有紀錄</b>，如此各位讀者應該知道各項資料（跳過 BBS 系統後）在能進入 Unix 的管理者前，其實都沒有保密性可言，有心想看就看。

可以看/刪除的資料包括
<ol><li>註冊真實資料</li><li>隱版文章</li><li>個人信件</li><li>個人水球記錄
</li></ol>我為什麼要提上面這一段呢？因為，另外據<a href="http://www.cib.gov.tw/news/news01_2.aspx?no=1788">刑事局這次所發的新聞稿</a>，當中提到一段：「（二）另經本局檢視該硬碟發現存有異常檔案「hixxxAll」及「pxx.PASSWD」，其中hixxxAll檔案內容為中○電信公司之電子郵件用戶帳號及密碼等資料(共2百多萬筆，若遭不法利用可窺視民眾之電子郵件，嚴重危害民眾隱私。)另<font color="#ff0000"><b>pxx.PASSWD檔案內容為著名網路社群批○○實業坊(pxx.cc)之會員帳號、密碼、電子郵件、會員姓名及地址等資料(共數十萬筆)</b></font>，研判係駭客入侵網站所竊取。」

先不論 .PASSWD 檔是什麼以及涵蓋什麼，光被拿到 .PASSWD 就意味著也許 shell 可能已被拿下（大概的意思是可變超級管理者）。 shell 被拿下，自然什麼都可看，什麼都可拿。

<b><big><big>入侵、破解手法揭密</big></big></b>

再論，如果我是駭客的話（再強調一次筆者並不是駭客，只是曾經對 BBS 系統非常熟悉，而且 BBS 的程式碼是 opensource 的，大家可自行抓回去研究原理），除了 .PASSWD 不會放過外，還會再拿一樣東西，就是 register.log。

register.log 是什麼呢？簡單的說，就是所有使用者的註冊資料。大多數 BBS 對於註冊資料的作法，便是將資料存在 register.log，每增加一個使用者，便在檔尾附加進去（append），時間久了，裡面就是一大串肉粽。<b>通常向警察報案 BBS 有人誹謗你，警察行文給 BBS，大多數也是調 LOGIN 記錄與 register.log</b>。

[注意，這裡並非是使用 PTT 資料做為畫面]

 <a href="http://www.flickr.com/photos/14765209@N00/1442509431/" title="相片分享"><img src="http://farm2.static.flickr.com/1326/1442509431_871fbd63e7_m.jpg" alt="register" height="194" width="240" /></a>

&nbsp;register.log 截圖

鏡頭再拉回 .PASSWD 檔，這是什麼呢？這是存個人密碼的檔。雖是 binary 檔，但也非不可解析。先用 <a href="http://www.flickr.com/photo_zoom.gne?id=1443421294&amp;size=o">hexdump</a>，再參考公開的 <a href="http://nopa.csie.org/d4124">struct.h</a>&nbsp; 自行撰寫轉成<a href="http://www.flickr.com/photo_zoom.gne?id=1442556877&amp;size=o">明碼文字檔</a>，再刪減成可用讓 john （一支著名暴力法破密碼程式）跑的<a href="http://www.flickr.com/photo_zoom.gne?id=1442557235&amp;size=o">格式</a>。<b> john 跑完就可得密碼</b>。


這裡好像沒有八卦，感覺都加密過（使用 DES加密），就算暴力跑也要花上很多時間吧？這又錯了。一般網頁論壇使用的大多是 md5 加密（比 DES 長度高，也安全一些，但目前卻有 <a href="http://www.itis.tw/node/1023">rainbow table</a> 可暴力破一部份）。八卦的是：DES 雖沒有 rainbow table，但 PTT 有效密碼長度只有八碼（你密碼十二個字打只前八個字也可以 login啦！）。據知名但不願具名的資安專家指稱，快速的破解法是自行撰寫 john rule 並且利用之前 log 或 sniffer 的明文加入 password db 作破解依據，據實務操作案例，約<strong>有 70% 以上的密碼可以 john 跑出明文（且是快速跑出，並非針對某特定帳號）</strong>（。且一般&nbsp; bbs 註冊都要求填另外的 email，<strong>5~10% 的 case 可以用 bbs 跑出的密碼登入 bbs 註冊時填的 email</strong>。（這裡筆者猜測會有 10% 這麼低，可能因為 BBS 大多只收 .edu.tw 的信箱，但是學校的 mail 密碼變更手續的知識門檻很高，因專家指出從 web forum 偷的 db，其破解出的密碼可登入註冊 mail 的比例就相當高）

恐怖吧。更恐怖的是，沒人知道 BBS 被入侵後，後續發展會怎麼樣。因為<b>誰都不能保證駭客只是乖乖的偷看資料，拷貝資料，不會放後門</b>。可以放後門又怎樣呢？當然是可以再進來摸東摸西偷裝東西啊。還可以偷裝什麼東西？筆者就舉個最近 知名南部 BBS 索尼小站 的案例吧，索尼小站發生的事情就是程式碼被改過，結果：

<pre><font><font><font class="col037"><font class="col040">    1)  有一個神秘的通用密碼可以登入任何帳號

    2)  登入成功後，密碼會被記錄在某個檔案中</font></font></font></font></pre>直接記錄密碼，連 john 都不用跑。所以<b>當然是跑進來偷改程式啊</b>！再據前面提到的知名但不願具名的資安專家的說法，改 source code 還被發現是很笨的，正解是改 source code 編譯出真正運作的 binary 檔過後，把 source code 再改回去，神不知鬼不覺。而且，還可以透過 UNIX 的 LD_PRELOAD（也就是 DLL Hijack 技術），這種方法連程式碼都不用改。


鄉民以為安全的 BBS，其實保安程度跟紙糊的差不多。而且 BBS 架站技術因為沒落，原始碼也骯髒、入門需要比較高的技術門檻，因此補洞並不時興也往往不是第一要務 ( 加同時上站人數應該是第一優先）。這次 PTT 被爆出密碼遭竊只是冰山一角，而全是因為 PTT 是全台第一大站的關係，才有如此小小波動，相信年久失修被入侵的老站和小站應該更多。可是大眾對於這類的資訊十分的缺乏，且也幾乎沒有多少人願意明講 BBS 遭入侵事件中，可入侵到何種程度的程度以及被竊取的資料洩漏程度（ .PASSWD 和 register.log ），甚至大部分站台遭到入侵，連<b>建議修改密碼公告也往往只是小小一幅</b>。因此興起了我為此文的撰文目的（我連打了一個禮拜晚上的電動，文章都拖到不想寫，<a href="http://guildwars.nctaiwan.com/">激戰</a>超好玩XD），希望能喚起大家重視在 BBS 上需提防的操作細節，以及建議儘速修改密碼。

本文若有錯漏之，煩請告知。感謝各位花了這麼多時間看我在這裡連番胡天蓋地，晚安。


最後感謝兩位資安界大大（避免曝光，故隱去姓名）提供相關 sample 檔以及專業技術指導。



